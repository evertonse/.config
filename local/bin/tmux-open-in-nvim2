#!/bin/bash

# Default file path if no argument provided
file="${1:-$HOME/todo.md}"

# Expand the path to handle ~
file=$(eval echo "$file")

# Find first pane running nvim/neovim
pane=$(tmux list-panes -F '#{pane_id} #{pane_current_command}' | grep -E 'n?vim' | head -n 1 | awk '{print $1}')

if [ -n "$pane" ]; then
    # Get the TTY of the pane
    tty=$(tmux display-message -p -t "$pane" '#{pane_tty}')
    
    # Find the Neovim server listening on this TTY
    server=$(nvr --serverlist | grep "$tty" | head -n 1)
    
    if [ -n "$server" ]; then
        # Use nvr to open the file in the existing instance
        NVIM_LISTEN_ADDRESS="$server" nvr --remote "$file"
    else
        # Fallback to tmux send-keys method
        tmux send-keys -t "$pane" Escape Escape
        tmux send-keys -t "$pane" ":wa" Enter
        tmux send-keys -t "$pane" ":e $file" Enter
    fi
else
    echo "No Vim/Neovim instance found in the current tmux window."
    exit 1
fi
